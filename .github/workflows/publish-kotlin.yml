name: Publish Kotlin Bindings

on:
  repository_dispatch:
    types: [cdk-release]
  workflow_dispatch:
    inputs:
      version:
        description: 'New version (e.g., 0.1.0)'
        required: true
        type: string
      cdk_repo:
        description: 'CDK repository (owner/repo format)'
        required: true
        default: 'cashubtc/cdk'
        type: string
      cdk_ref:
        description: 'CDK repository ref (branch/tag)'
        required: true
        default: 'main'
        type: string

env:
  GRADLE_OPTS: -Dorg.gradle.daemon=false -Dorg.gradle.configuration-cache=false

jobs:
  publish:
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout cdk-kotlin
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    - name: Free Disk Space (Ubuntu)
      uses: jlumbroso/free-disk-space@main
      with:
        tool-cache: false
        android: false
        dotnet: true
        haskell: true
        large-packages: true
        docker-images: true
        swap-storage: true

    - name: Set variables
      id: vars
      run: |
        # Handle both repository_dispatch and workflow_dispatch
        if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
          VERSION="${{ github.event.client_payload.version }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "cdk_repo=${{ github.event.client_payload.cdk_repo || 'cashubtc/cdk' }}" >> $GITHUB_OUTPUT
          echo "cdk_ref=${{ github.event.client_payload.cdk_ref || github.event.client_payload.version }}" >> $GITHUB_OUTPUT
        else
          VERSION="${{ inputs.version }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "cdk_repo=${{ inputs.cdk_repo }}" >> $GITHUB_OUTPUT
          echo "cdk_ref=${{ inputs.cdk_ref }}" >> $GITHUB_OUTPUT
        fi

        # Check if version contains 'rc' (case insensitive) to mark as prerelease
        if echo "$VERSION" | grep -qi "rc"; then
          echo "is_prerelease=true" >> $GITHUB_OUTPUT
        else
          echo "is_prerelease=false" >> $GITHUB_OUTPUT
        fi

    - name: Checkout CDK
      uses: actions/checkout@v4
      with:
        repository: ${{ steps.vars.outputs.cdk_repo }}
        ref: ${{ steps.vars.outputs.cdk_ref }}
        path: cdk
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Calculate flake hash
      id: flake-hash
      run: echo "hash=${{ hashFiles('flake.nix', 'flake.lock') }}" >> $GITHUB_OUTPUT

    - name: Install Nix
      uses: DeterminateSystems/nix-installer-action@v17

    - name: Nix Cache
      uses: DeterminateSystems/magic-nix-cache-action@main
      with:
        diagnostic-endpoint: ""
        use-flakehub: false

    - name: Rust Cache
      uses: Swatinem/rust-cache@v2
      with:
        shared-key: "stable-${{ steps.flake-hash.outputs.hash }}"

    - name: Cache Rust dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          cdk/target
        key: ${{ runner.os }}-cargo-${{ hashFiles('cdk/**/Cargo.lock') }}

    - name: Cache Gradle dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}

    - name: Generate Kotlin bindings
      run: nix develop .#ci --command just generate

    - name: Build Android libraries
      run: nix develop .#ci --command bash ./scripts/build-android.sh

    - name: Update version in build.gradle.kts
      run: |
        sed -i 's/version = "[^"]*"/version = "${{ steps.vars.outputs.version }}"/' lib/build.gradle.kts

    - name: Update version in README.md
      run: |
        sed -i 's/implementation("[^"]*:cdk-kotlin:[^"]*")/implementation("org.cashudevkit:cdk-kotlin:${{ steps.vars.outputs.version }}")/' README.md

    - name: Build library
      run: nix develop .#ci --command ./gradlew :lib:assembleRelease

    - name: Run tests
      run: |
        echo "Skipping tests in CI environment - requires native library compatibility"
        echo "Tests can be run locally with: ./gradlew :lib:testReleaseUnitTest"
        # TODO: Fix tests to work without native libraries or build x86_64 library for CI
        # nix develop .#ci --command ./gradlew :lib:testReleaseUnitTest

    - name: Build AAR
      run: nix develop .#ci --command ./gradlew :lib:bundleReleaseAar

    - name: Publish to Maven Central
      env:
        ORG_GRADLE_PROJECT_signingKey: ${{ secrets.SIGNING_KEY }}
        ORG_GRADLE_PROJECT_signingPassword: ${{ secrets.SIGNING_PASSWORD || '' }}
        ORG_GRADLE_PROJECT_sonatypeUsername: ${{ secrets.SONATYPE_USERNAME }}
        ORG_GRADLE_PROJECT_sonatypePassword: ${{ secrets.SONATYPE_PASSWORD }}
      run: |
        echo "Publishing to Central Portal via staging API..."
        nix develop .#ci --command ./gradlew --no-configuration-cache :lib:publishToSonatype closeAndReleaseSonatypeStagingRepository

    - name: Create and push tag
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add lib/build.gradle.kts README.md
        git commit -m "Release version ${{ steps.vars.outputs.version }}"
        git tag -a "v${{ steps.vars.outputs.version }}" -m "Release version ${{ steps.vars.outputs.version }}"
        git push origin HEAD:main
        git push origin "v${{ steps.vars.outputs.version }}"

    - name: Create GitHub Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ steps.vars.outputs.version }}
        release_name: Release ${{ steps.vars.outputs.version }}
        body: |
          ## CDK Kotlin ${{ steps.vars.outputs.version }}

          Kotlin/Android bindings for the Cashu Development Kit.

          ### Installation

          Add to your `build.gradle.kts`:

          ```kotlin
          dependencies {
              implementation("org.cashudevkit:cdk-kotlin:${{ steps.vars.outputs.version }}")
          }
          ```

          ### Changes

          Built from CDK repository: ${{ steps.vars.outputs.cdk_repo }}@${{ steps.vars.outputs.cdk_ref }}
        draft: false
        prerelease: ${{ steps.vars.outputs.is_prerelease == 'true' }}

    - name: Upload AAR to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./lib/build/outputs/aar/lib-release.aar
        asset_name: cdk-kotlin-${{ steps.vars.outputs.version }}.aar
        asset_content_type: application/octet-stream

    - name: Notify on failure
      if: failure()
      run: |
        echo "‚ùå Release workflow failed"
        echo ""
        echo "üîç If you got a 401 error, you need to update to Central Portal credentials:"
        echo "1. Go to https://central.sonatype.com/account"
        echo "2. Generate User Token"
        echo "3. Update SONATYPE_USERNAME and SONATYPE_PASSWORD secrets with the token values"
        echo "4. See CENTRAL_PORTAL_SETUP.md for detailed instructions"
        echo ""
        echo "üìñ Other common issues:"
        echo "  - PGP signing key problems (check SIGNING_KEY/SIGNING_PASSWORD)"
        echo "  - Version already exists on Maven Central"
        echo "  - Network connectivity issues"
